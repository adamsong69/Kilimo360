name: Android Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_API: 33
      ANDROID_MIN_API: 21
      ANDROID_NDK: r25b

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set Python version
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set project dir
        run: |
          PROJECT_DIR=$(find . -name "buildozer.spec" -exec dirname {} \; | sed 's|^\./||')
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV
          echo "Project folder: $PROJECT_DIR"

      - name: Set up virtual environment and install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install buildozer==1.5.0 python-for-android==2024.1.21

      - name: Prepare icons/presplash
        run: |
          echo "Checking and copying icons/presplash..."
          ICON_SRC="${{ env.PROJECT_DIR }}/assets/icon.png"
          PRESPLASH_SRC="${{ env.PROJECT_DIR }}/assets/presplash.png"

          if [ -f "$ICON_SRC" ]; then
            cp "$ICON_SRC" "$PROJECT_DIR/icon.png"
            echo "icon.png copied"
          else
            echo "icon.png missing, skipping copy"
          fi

          if [ -f "$PRESPLASH_SRC" ]; then
            cp "$PRESPLASH_SRC" "$PROJECT_DIR/presplash.png"
            echo "presplash.png copied"
          else
            echo "presplash.png missing, skipping copy"
          fi

      - name: Build APK
        run: |
          source venv/bin/activate
          cd ${{ env.PROJECT_DIR }}
          buildozer android debug
